#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะทะฐะฟััะบั ะฒััั ัะตัััะฒ ะฟัะฐะบัะธัะฝะพั ัะพะฑะพัะธ โ10

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ  ะัะฐะบัะธัะฝะฐ ัะพะฑะพัะฐ โ10: ะะพะผะฟะปะตะบัะฝะต ัะตัััะฒะฐะฝะฝั                  โ"
echo "โ  Enterprise-ะทะฐััะพััะฝะบั ะท ะฒะธะบะพัะธััะฐะฝะฝัะผ ััะทะฝะธั ะฟัะดัะพะดัะฒ       โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# ะะพะปัะพัะธ ะดะปั ะฒะธะฒะพะดั
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ะคัะฝะบััั ะดะปั ะฒะธะฒะพะดั ะทะฐะณะพะปะพะฒะบัะฒ
print_header() {
    echo -e "${BLUE}=== $1 ===${NC}"
}

# ะคัะฝะบััั ะดะปั ะฒะธะฒะพะดั ััะฟััั
print_success() {
    echo -e "${GREEN}โ $1${NC}"
}

# ะคัะฝะบััั ะดะปั ะฒะธะฒะพะดั ะฟะพะผะธะปะบะธ
print_error() {
    echo -e "${RED}โ $1${NC}"
}

# ะคัะฝะบััั ะดะปั ะฒะธะฒะพะดั ะฟะพะฟะตัะตะดะถะตะฝะฝั
print_warning() {
    echo -e "${YELLOW}โ๏ธ  $1${NC}"
}

# ะะตัะตะฒััะบะฐ ะฝะฐัะฒะฝะพััั Java
print_header "ะะตัะตะฒััะบะฐ ัะตัะตะดะพะฒะธัะฐ"
if ! command -v java &> /dev/null; then
    print_error "Java ะฝะต ะทะฝะฐะนะดะตะฝะฐ. ะัะดั ะปะฐัะบะฐ, ะฒััะฐะฝะพะฒััั Java 17+"
    exit 1
fi

JAVA_VERSION=$(java -version 2>&1 | head -n 1 | cut -d'"' -f2 | cut -d'.' -f1)
if [ "$JAVA_VERSION" -lt 17 ]; then
    print_error "ะะพัััะฑะฝะฐ Java 17+, ะทะฝะฐะนะดะตะฝะฐ Java $JAVA_VERSION"
    exit 1
fi
print_success "Java $JAVA_VERSION ะทะฝะฐะนะดะตะฝะฐ"

# ะะตัะตะฒััะบะฐ ะฝะฐัะฒะฝะพััั Maven
if ! command -v mvn &> /dev/null; then
    print_error "Maven ะฝะต ะทะฝะฐะนะดะตะฝะธะน. ะัะดั ะปะฐัะบะฐ, ะฒััะฐะฝะพะฒััั Maven 3.6+"
    exit 1
fi
print_success "Maven ะทะฝะฐะนะดะตะฝะธะน"

# ะัะธัะตะฝะฝั ัะฐ ะบะพะผะฟัะปัััั
print_header "ะะพะผะฟัะปัััั ะฟัะพัะบัั"
echo "ะัะธัะตะฝะฝั ัะฐ ะบะพะผะฟัะปัััั..."
if mvn clean compile -q; then
    print_success "ะะพะผะฟัะปัััั ะทะฐะฒะตััะตะฝะฐ ััะฟััะฝะพ"
else
    print_error "ะะพะผะธะปะบะฐ ะบะพะผะฟัะปัััั"
    exit 1
fi

# ะะฐะฟััะบ ะผะพะดัะปัะฝะธั ัะตัััะฒ
print_header "ะะพะดัะปัะฝั ัะตััะธ (Unit Tests)"
echo "ะะฐะฟััะบ ะผะพะดัะปัะฝะธั ัะตัััะฒ..."
if mvn test -Dtest="*Test" -q; then
    print_success "ะะพะดัะปัะฝั ัะตััะธ ะฟัะพะนัะปะธ ััะฟััะฝะพ"
else
    print_error "ะะพะดัะปัะฝั ัะตััะธ ะฝะต ะฟัะพะนัะปะธ"
    exit 1
fi

# ะะฐะฟััะบ ัะฝัะตะณัะฐััะนะฝะธั ัะตัััะฒ
print_header "ะะฝัะตะณัะฐััะนะฝั ัะตััะธ (Integration Tests)"
echo "ะะฐะฟััะบ ัะฝัะตะณัะฐััะนะฝะธั ัะตัััะฒ..."
if mvn test -Dtest="*IntegrationTest" -q; then
    print_success "ะะฝัะตะณัะฐััะนะฝั ัะตััะธ ะฟัะพะนัะปะธ ััะฟััะฝะพ"
else
    print_error "ะะฝัะตะณัะฐััะนะฝั ัะตััะธ ะฝะต ะฟัะพะนัะปะธ"
    exit 1
fi

# ะะฐะฟััะบ ัะตัััะฒ ะฑะตะทะฟะตะบะธ
print_header "ะขะตััะธ ะฑะตะทะฟะตะบะธ (Security Tests)"
echo "ะะฐะฟััะบ ัะตัััะฒ ะฑะตะทะฟะตะบะธ..."
if mvn test -Dtest="*SecurityTest" -q; then
    print_success "ะขะตััะธ ะฑะตะทะฟะตะบะธ ะฟัะพะนัะปะธ ััะฟััะฝะพ"
else
    print_error "ะขะตััะธ ะฑะตะทะฟะตะบะธ ะฝะต ะฟัะพะนัะปะธ"
    exit 1
fi

# ะะฐะฟััะบ ะทะฐััะพััะฝะบั ะฒ ัะพะฝะพะฒะพะผั ัะตะถะธะผั
print_header "ะะฐะฟััะบ ะทะฐััะพััะฝะบั"
echo "ะะฐะฟััะบ Spring Boot ะทะฐััะพััะฝะบั..."
mvn spring-boot:run > app.log 2>&1 &
APP_PID=$!

# ะััะบัะฒะฐะฝะฝั ะทะฐะฟััะบั ะทะฐััะพััะฝะบั
echo "ะััะบัะฒะฐะฝะฝั ะทะฐะฟััะบั ะทะฐััะพััะฝะบั..."
for i in {1..30}; do
    if curl -s http://localhost:8080/api/orders/generate-order-id > /dev/null 2>&1; then
        print_success "ะะฐััะพััะฝะพะบ ะทะฐะฟััะตะฝะพ ััะฟััะฝะพ"
        break
    fi
    if [ $i -eq 30 ]; then
        print_error "ะะฐััะพััะฝะพะบ ะฝะต ะทะฐะฟัััะธะฒัั ะฟัะพััะณะพะผ 30 ัะตะบัะฝะด"
        kill $APP_PID 2>/dev/null
        exit 1
    fi
    sleep 1
done

# ะขะตััะธ ะฟัะพะดัะบัะธะฒะฝะพััั (ัะบัะพ JMeter ะดะพัััะฟะฝะธะน)
print_header "ะขะตััะธ ะฟัะพะดัะบัะธะฒะฝะพััั (Performance Tests)"
if command -v jmeter &> /dev/null; then
    echo "ะะฐะฟััะบ ัะตัััะฒ ะฟัะพะดัะบัะธะฒะฝะพััั ะท JMeter..."
    if ./src/test/jmeter/run-performance-tests.sh; then
        print_success "ะขะตััะธ ะฟัะพะดัะบัะธะฒะฝะพััั ะทะฐะฒะตััะตะฝั"
    else
        print_warning "ะขะตััะธ ะฟัะพะดัะบัะธะฒะฝะพััั ะฝะต ะฟัะพะนัะปะธ (ะผะพะถะปะธะฒะพ JMeter ะฝะต ะฝะฐะปะฐััะพะฒะฐะฝะธะน)"
    fi
else
    print_warning "JMeter ะฝะต ะทะฝะฐะนะดะตะฝะธะน, ะฟัะพะฟััะบะฐัะผะพ ัะตััะธ ะฟัะพะดัะบัะธะฒะฝะพััั"
fi

# ะัะฟะธะฝะบะฐ ะทะฐััะพััะฝะบั
print_header "ะะฐะฒะตััะตะฝะฝั"
echo "ะัะฟะธะฝะบะฐ ะทะฐััะพััะฝะบั..."
kill $APP_PID 2>/dev/null
wait $APP_PID 2>/dev/null
print_success "ะะฐััะพััะฝะพะบ ะทัะฟะธะฝะตะฝะพ"

# ะัะดััะผะพะบ
print_header "ะัะดััะผะพะบ ะฒะธะบะพะฝะฐะฝะฝั"
echo ""
echo "๐ ะะตะทัะปััะฐัะธ ัะตัััะฒะฐะฝะฝั:"
echo "   โ ะะพะดัะปัะฝั ัะตััะธ - ะะะะะจะะ"
echo "   โ ะะฝัะตะณัะฐััะนะฝั ัะตััะธ - ะะะะะจะะ"
echo "   โ ะขะตััะธ ะฑะตะทะฟะตะบะธ - ะะะะะจะะ"
echo "   โ ะะฐััะพััะฝะพะบ - ะะะะฃะฉะะะ"
if command -v jmeter &> /dev/null; then
    echo "   โ ะขะตััะธ ะฟัะพะดัะบัะธะฒะฝะพััั - ะะะะะะจะะะ"
else
    echo "   โ๏ธ  ะขะตััะธ ะฟัะพะดัะบัะธะฒะฝะพััั - ะะะะะฃะฉะะะ (JMeter ะฝะต ะทะฝะฐะนะดะตะฝะธะน)"
fi

echo ""
echo "๐ฏ ะัั ะพัะฝะพะฒะฝั ัะตััะธ ะฟัะพะนัะปะธ ััะฟััะฝะพ!"
echo ""
echo "๐ ะะพัะธัะฝั ัะฐะนะปะธ:"
echo "   - ะะพะณะธ ะทะฐััะพััะฝะบั: app.log"
echo "   - ะะตะทัะปััะฐัะธ JMeter: target/jmeter/"
echo "   - ะะฒััะธ ัะตัััะฒ: target/surefire-reports/"
echo ""
echo "๐ ะะปั ัััะฝะพะณะพ ัะตัััะฒะฐะฝะฝั ะทะฐะฟัััััั:"
echo "   mvn spring-boot:run"
echo "   # ะะฐััะพััะฝะพะบ ะฑัะดะต ะดะพัััะฟะฝะธะน ะฝะฐ http://localhost:8080"
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ  ะัะฐะบัะธัะฝะฐ ัะพะฑะพัะฐ โ10 ะะะะะะจะะะ ะฃะกะะะจะะ! ๐                  โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
